(()=>{"use strict";var e=function(e,o,i,r){return new(i||(i=Promise))((function(t,a){function s(e){try{l(r.next(e))}catch(e){a(e)}}function n(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var o;e.done?t(e.value):(o=e.value,o instanceof i?o:new i((function(e){e(o)}))).then(s,n)}l((r=r.apply(e,o||[])).next())}))};function o(e,o){console.log(`[Design System Analyzer] ${e}`,o||"")}function i(e,o,i){const r=e=>{const o=Math.round(255*e).toString(16);return 1===o.length?"0"+o:o};return`#${r(e)}${r(o)}${r(i)}`}function r(o,t,a){return e(this,void 0,void 0,(function*(){try{let e=figma.variables.getLocalVariables("COLOR").find((e=>e.key===a));if(!e)try{e=yield figma.variables.importVariableByKeyAsync(a),console.log("Variable imported successfully:",e.name)}catch(e){return console.error("Error importing variable:",e),void figma.notify("Failed to import color variable from library")}if(!e)return void figma.notify("Variable not found");if("fills"in o){const r=o.fills;if(Array.isArray(r)){const a=r.map((o=>"SOLID"===o.type&&i(o.color.r,o.color.g,o.color.b)===t?figma.variables.setBoundVariableForPaint(o,"color",e):o));o.fills=a}}if("children"in o)for(const e of o.children)yield r(e,t,a)}catch(e){console.error("Error replacing fills:",e),figma.notify(`Error: ${e.message||"Unknown error occurred"}`)}}))}function t(e){const o=[];return e!==figma.mixed&&e.length?(e.forEach((e=>{var r;if("SOLID"===e.type){const t=i(e.color.r,e.color.g,e.color.b);let a=o.find((e=>e.hex===t));if(a||(a={hex:t,directUses:0,variableUses:0},o.push(a)),null===(r=e.boundVariables)||void 0===r?void 0:r.color){const o=figma.variables.getVariableById(e.boundVariables.color.id);if(o){const e=o.name.split("/"),i=e.length>1?e[e.length-2]+"/"+e[e.length-1]:o.name;a.variableName=i,a.variableId=o.id,a.variableKey=o.key,a.variableUses++;const r=figma.variables.getVariableCollectionById(o.variableCollectionId);r&&(a.variableName=`${r.name}/${i}`)}}else a.directUses++}})),o):o}figma.showUI(__html__,{width:400,height:600});const a=new Map;function s(e){return{id:e.id,key:e.key,name:e.name,value:e.valuesByMode[Object.keys(e.valuesByMode)[0]],collection:e.collectionId,isFromLibrary:e.remote,libraryName:e.remote?e.libraryName:void 0,remote:e.remote,valuesByMode:e.valuesByMode,resolvedType:e.resolvedType}}function n(i,r){return e(this,void 0,void 0,(function*(){var e;try{if(!1!==i.visible){if("COMPONENT"===i.type||"COMPONENT_SET"===i.type||"INSTANCE"===i.type){const t={id:i.id,name:i.name,description:"INSTANCE"===i.type?`Instance of ${(null===(e=i.mainComponent)||void 0===e?void 0:e.name)||"Unknown"}`:i.type};r.components.some((e=>e.id===t.id))||(r.components.push(t),o("Added component:",t))}else if("FRAME"===i.type){const e={id:i.id,name:i.name,description:"Frame"};r.components.some((o=>o.id===e.id))||(r.components.push(e),o("Added frame:",e))}if("fills"in i&&(i.fills&&t(i.fills).forEach((e=>{let i=r.colors.find((o=>o.hex===e.hex));i?(i.directUses+=e.directUses,i.variableUses+=e.variableUses,e.variableName&&(i.variableName=e.variableName,i.variableId=e.variableId,i.variableKey=e.variableKey)):(r.colors.push(e),o("Added color from fills:",e))})),"backgrounds"in i&&i.backgrounds&&t(i.backgrounds).forEach((e=>{let i=r.colors.find((o=>o.hex===e.hex));i?(i.directUses+=e.directUses,i.variableUses+=e.variableUses,e.variableName&&(i.variableName=e.variableName,i.variableId=e.variableId,i.variableKey=e.variableKey)):(r.colors.push(e),o("Added color from background:",e))})),"strokes"in i&&i.strokes&&t(i.strokes).forEach((e=>{let i=r.colors.find((o=>o.hex===e.hex));i?(i.directUses+=e.directUses,i.variableUses+=e.variableUses,e.variableName&&(i.variableName=e.variableName,i.variableId=e.variableId,i.variableKey=e.variableKey)):(r.colors.push(e),o("Added color from stroke:",e))}))),"textStyleId"in i&&i.textStyleId&&"TEXT"===i.type){const e=figma.getStyleById(i.textStyleId);if(e&&e.name){const i=e.name.split("/").pop()||e.name;r.textStyles.includes(i)||(r.textStyles.push(i),o("Added text style:",i))}}if("effects"in i&&i.effects&&i.effects.length>0&&function(e,o){e.forEach((e=>{let i="";"DROP_SHADOW"===e.type||"INNER_SHADOW"===e.type?i=`${e.type} (${e.color.r}, ${e.color.g}, ${e.color.b}, ${e.color.a})`:"LAYER_BLUR"!==e.type&&"BACKGROUND_BLUR"!==e.type||(i=`${e.type} (${e.radius}px)`),i&&!o.effects.includes(i)&&o.effects.push(i)}))}(i.effects,r),i.boundVariables)for(const[e,r]of Object.entries(i.boundVariables))if(r&&"object"==typeof r&&"id"in r){const e="string"==typeof r.id?r.id:r.id.toString(),i=yield figma.variables.getVariableByIdAsync(e);if(i){const e=s(i);a.has(e.id)||(a.set(e.id,e),o("Added variable:",e))}}if("children"in i)for(const e of i.children)yield n(e,r)}}catch(e){console.error("Error processing node:",e)}}))}figma.ui.onmessage=i=>e(void 0,void 0,void 0,(function*(){if("analyze-design-system"===i.type)try{if(0===figma.currentPage.selection.length)throw new Error("Please select at least one frame or component to analyze.");const e={colors:[],textStyles:[],effects:[],components:[]};for(const o of figma.currentPage.selection)if(yield n(o,e),"children"in o)for(const i of o.children)yield n(i,e);const i=[];0===e.components.length&&i.push("No components found in selection"),0===e.colors.length&&i.push("No colors found in selection"),0===e.textStyles.length&&i.push("No text styles found in selection"),0===e.effects.length&&i.push("No effects found in selection"),o("Analysis results:",{components:e.components.length,colors:e.colors.length,textStyles:e.textStyles.length,effects:e.effects.length});const r={components:e.components.map((e=>({name:e.name,type:e.description.includes("Instance")?"INSTANCE":"Frame"===e.description?"FRAME":"COMPONENT"}))),styles:e,inconsistencies:i};figma.ui.postMessage({type:"analysis-results",data:r})}catch(e){console.error("Analysis error:",e),figma.ui.postMessage({type:"error",message:e instanceof Error?e.message:"An unknown error occurred"})}else if("find-variables"===i.type)try{const{hex:o}=i.data,r=yield function(o){return e(this,void 0,void 0,(function*(){const e=[],i=function(e){const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!o)throw new Error("Invalid hex color");return{r:parseInt(o[1],16)/255,g:parseInt(o[2],16)/255,b:parseInt(o[3],16)/255}}(o),r=yield figma.variables.getLocalVariablesAsync("COLOR");for(const o of r)try{const r=yield figma.variables.getVariableCollectionByIdAsync(o.variableCollectionId);if(!r)continue;const s=r.modes[0],n=o.valuesByMode[s.modeId];if(n&&"object"==typeof n&&"r"in n){const s=n;if(t=s,a=i,Math.abs(t.r-a.r)<.001&&Math.abs(t.g-a.g)<.001&&Math.abs(t.b-a.b)<.001){const i={id:o.id,key:o.key,name:o.name,value:s,collection:r.name,isFromLibrary:o.remote,libraryName:r.remote?r.name:void 0};e.push(i)}}}catch(e){console.error("Error processing variable:",e)}var t,a;return e}))}(o);if(0===r.length)throw new Error("No variables found with this color");figma.ui.postMessage({type:"variable-options",data:{hex:o,variables:r}})}catch(e){figma.ui.postMessage({type:"error",message:e instanceof Error?e.message:"Failed to find variables"})}else if("use-variable"===i.type)try{const{hex:e,variableKey:o}=i.data;for(const i of figma.currentPage.selection)yield r(i,e,o);figma.ui.postMessage({pluginMessage:{type:"analyze-design-system"}})}catch(e){figma.ui.postMessage({type:"error",message:e instanceof Error?e.message:"Failed to use color variable"})}}))})();